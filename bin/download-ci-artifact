#!/usr/bin/env sh
set -eu -o pipefail

function main() {
    local workflow="$1"
    local q='.status.nodes | with_entries(select(.value.displayName=="ci-artifact"))| .[] | .outputs.artifacts | .[] | select(.name=="ci-artifact") | .s3.key'
    local s3key=$(kubectl get workflow "$workflow" -o json | jq -r "$q")
    aws s3 cp "s3://cet-splendid-elk-shrd/$s3key" artifact.tgz
    tar -xvf artifact.tgz
}

main $@
